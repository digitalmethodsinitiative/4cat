<div class="item-annotations">
	
	{% if annotation_fields %}
        {% set item_id = item.id|string %}
		{% set item_annotations = annotations.get(item_id, {}) %}
        {% for field_id in annotation_fields %}
            {% if not annotation_fields[field_id].hide_in_explorer %}
                {% set type = annotation_fields[field_id]["type"] %}
                {% set label = annotation_fields[field_id]["label"] %}
                {% set from_dataset = annotation_fields[field_id].get("from_dataset", "") %}

                {# Loop through annotations for this item and
                retrieve the data from the one matching this annotation field id #}
                {% set an = namespace(an={}) %}
                {% for annotation_field_id, item_annotation in item_annotations.items() %}
                    {% if annotation_field_id  == field_id %}
                        {% set an.an = item_annotation %}
                    {% endif %}
                {% endfor %}
                {% set annotation = an.an %}
                {# Show empty values for human-made annotations, not for processor-made ones #}
                {% if not (from_dataset and not annotation.value) %}
                    <div class="item-annotation field-{{ field_id }} type-{{ type }} item-id-{{ item.id }}">
                        {# If generated by a processor, link to the dataset and simply output the text; it can't be edited '#}
                        {% if from_dataset %}
                            <label class="annotation-label"><i class="fa-solid fa-tag"></i> <a href="{{ url_for('dataset.show_result', key=from_dataset)}}" target="_blank" class="from-dataset-link">{{ label }}</a></label>
                        {% else %}
                            <label class="annotation-label"><i class="fa-solid fa-tag"></i> {{ label }}</label>
                        {% endif %}

                        {# If generated by a processor, just output the generated text #}
                        <div class="item-annotation-value">
                            {% if from_dataset %}
                                <div class="item-annotation-input from-dataset">{{ annotation.value }}</div>
                                {% set item = from_datasets[annotation.from_dataset] %}
                                {% if item.type in processors %}
                                    {% set processor_options = processors[item.type].get_options(config=__config) %}
                                {% endif %}
                                <div class="item-annotation-parameters">
                                    <ul>
                                    {% for option in item.parameters %}
                                        {% if option in processor_options and processor_options[option].type not in ("annotation", "annotations") %}
                                            {% set extra_tooltip_id =  annotation.id %}
                                            {% include 'components/result-parameter.html' %}
                                        {% endif %}
                                    {% endfor %}
                                    </ul>
                                </div>
                            {% elif type == "text" %}
                                <input type="text" class="item-annotation-input" value="{{ annotation.value }}">

                            {% elif type == "textarea" %}
                                <textarea class="item-annotation-input">{{ annotation.value }}</textarea>

                            {% elif type == "dropdown" %}
                                <select class="item-annotation-input">
                                    <option class="item-annotation-option" value=""></option>

                                {% for option_id, option_label in annotation_fields[field_id]["options"].items() %}
                                    <option class="item-annotation-option option-{{ option_id }}" id="option-{{ option_id }}" value="{{ option_label }}" {% if option_label == annotation.value %}selected{% endif %}>{{ option_label }}</option>
                                {% endfor %}
                                </select>

                            {% elif type == "checkbox" %}
                                <div class="item-annotation-options">
                                {% for option_id, option_label in annotation_fields[field_id]["options"].items() %}
                                    <div class="item-annotation-checkbox-container">
                                        {% set checked = "checked" if option_label in annotation.value else "" %}
                                        <input type="checkbox" class="item-annotation-input option-{{ option_id }}" id="option-{{ item.id }}-{{ option_id }}" value="{{ option_label }}" {{ checked }}><label for="option-{{ item.id }}-{{ option_id }}">{{ option_label }}</label>
                                    </div>
                                {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        {# Tooltip with metadata on the annotation #}
                        {% if annotation.author or annotation.author_original or annotation.timestamp or annotation.metadata %}
                            <button class="tooltip-trigger" aria-controls="tooltip-annotation-metadata-{{ item.id }}-{{ annotation.field_id }}">?</button>
                            <p role="tooltip" id="tooltip-annotation-metadata-{{ item.id }}-{{ annotation.field_id }}" aria-hidden="true">
                            {% if annotation.author_original %}
                                <span class="tooltip-line">Created by {% if annotation.by_processor %} processor{% endif %} {% if annotation.author_original %}<strong>{{ annotation.author_original }}</strong>{% endif %}
                                {% if annotation.timestamp_created %}
                                    on <span class="timestamp-created timestamp-to-convert">{{ annotation.timestamp_created }}</span>
                                {% endif %}</span>
                            {% endif %}
                            {% if annotation.author != annotation.author_original or annotation.timestamp != annotation.timestamp_created %}
                                <span class="tooltip-line">Edited by{% if annotation.by_processor %} processor{% endif %} {% if annotation.author %}<strong><span class="annotation-author">{{ annotation.author }}</span></strong>{% endif %}{% if annotation.timestamp %} on <span class="timestamp-edited timestamp-to-convert">{{ annotation.timestamp }}</span>{% endif %}
                            {% endif %}</span>
                            </p>
                        {% endif %}

                        {# Store some invisible data here to we can retrieve in with JS #}
                        <div class="annotation-data" style="display: none;">
                            <span class="epoch-timestamp-edited">{{ annotation.timestamp }}</span>
                            <span class="annotation-author">{{ annotation.author }}</span>
                            <span class="annotation-options">{{ annotation_fields[field_id].get("options", {}).values() | join(",") }}</span>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
		{% endfor %}
	{% endif %}
</div>